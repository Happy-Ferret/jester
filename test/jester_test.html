<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">  
    <title>jester.js</title>
    <script language="JavaScript" type="text/javascript" src="jsunit/app/jsUnitCore.js"></script>
    <script language="JavaScript" type="text/javascript" src="../prototype.js"></script>
    <script language="JavaScript" type="text/javascript" src="../ObjTree.js"></script>
    <script language="JavaScript" type="text/javascript" src="../date.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jester.js"></script>
  </head>

  <body>
    <script language="JavaScript" type="text/javascript">

function setUp () {
  default_prefix = function() {return "http://" + window.location.hostname + (window.location.port ? ":" + window.location.port : "");}

  postDetails1 = { 'id' : { '@type' : 'integer', '#text' : '1' }, 'title' : 'the title', 'body' : 'the body' }
  postDetails2 = { 'id' : { '@type' : 'integer', '#text' : '2' }, 'title' : 'another title', 'body' : 'another body' }
  postDetails3 = { 'id' : { '@type' : 'integer', '#text' : '2' }, 'title' : 'yet another title', 'body' : 'yet another body' }
  ericDetails = {
    'id' : { '@type' : 'integer', '#text' : '1' },
    'first-name' : 'eric',
    'admin' : { '@type' : 'boolean', '#text' : 'true' },
    'created_at' : { '@type' : 'datetime', '#text' : '2007-04-08T15:12:06-04:00' },
    'posts' : { 
      'post' : [postDetails1, postDetails2]
    }
  }
  johnDetails = {
    'id' : { '@type' : 'integer', '#text' : '2' },
    'first-name' : 'john',
    'admin' : { '@type' : 'boolean', '#text' : 'false' },
    'created_at' : { '@type' : 'datetime', '#text' : '2007-04-09T15:12:06-04:00' },
    'posts' : { 
      'post' : postDetails3
    }
  }
  chadDetails = {
    'id' : { '@type' : 'integer', '#text' : '3' },
    'first-name' : 'chad',
    'admin' : { '@type' : 'boolean', '#text' : 'true' },
    'created_at' : { '@type' : 'datetime', '#text' : '2007-04-10T15:12:06-04:00' },
  }
  
  allUsersDetails = {
    'users' : {
      'user' : [ericDetails, johnDetails, chadDetails]
    }
  }
  
  allPostsDetails = {
    'posts' : {
      'post' : [postDetails1, postDetails2, postDetails3]
    }
  }  
  
  // test for belongs_to, separate from normal universe
  postIncludeDetails = { 
    'id' : { '@type' : 'integer', '#text' : '3' },
    'title' : 'another title', 
    'body' : 'another body',
    'user' : ericDetails
  }
  
  // test for finding all, but where ObjTree doesn't use an array because there is only one result
  allWithOneUserDetails = {
    'users' : {
      'user' : ericDetails
    }
  }

  // used to make sure callbacks get called
  changed = false;
  change = function() {changed = true;}
  
  // initiate models
  Base.model("User")
  Base.model("Post")
  Base.tree.parseHTTP = function (url, options, callback) {
    if (url == User._singular_url(1))
      return {'user': ericDetails}
    else if (url == Post._singular_url(1))
      return {'post': postDetails1}
    else if (url == User._plural_url())
      return allUsersDetails;
  }
  
}


/********************************************
 ************ FIND TESTS ********************
 ********************************************/

function testFind () {
  Base.model('User', 'http://www.thoughtbot.com');

	var eric = User.find(1);
	assertEquals('User', eric._name)
	assertEquals('user', eric._singular);
	assertEquals('users', eric._plural);
	assertEquals('http://www.thoughtbot.com', eric._prefix);
	assertEquals(1, eric.id);
	assertEquals('eric', eric.first_name);
	// test date parsing
	assertEquals(Date, eric.created_at.constructor)
	assertEquals(2007, eric.created_at.getFullYear())
	assertEquals(3, eric.created_at.getMonth())
	assert(eric.admin);

	assertEquals(2, eric.posts.length);
	assertEquals(1, eric.posts[0].id);
	assertEquals('the title', eric.posts[0].title);
	assertEquals('the body', eric.posts[0].body);
	assertEquals('another title', eric.posts[1].title);
	assertEquals('another body', eric.posts[1].body);
}

function testFindAll () {
  var User = new Base('User');
  Base.tree = { parseHTTP :
    function (url, options, callback) {
      if (url == User._plural_url())
        return allUsersDetails;
      else if (url == User._singular_url(1))
        return {'user': ericDetails};
    }
  }
  
  var users = User.find('all');
  assertEquals(3, users.length);
  
  var eric = User.find(1);
  for (var i =0; i<eric.properties.length; i++)
    assertEquals(eric.properties[i], users[0].properties[i]);
    
  assertEquals(eric.first_name, users[0].first_name);
  assertEquals(eric.constructor, users[0].constructor);
  for (var i=0; i<3; i++)
    assertEquals(i+1, users[i].id)
  
  Base.tree = { parseHTTP :
    function (url, options, callback) {
      return allWithOneUserDetails;
    }
  }
  
  var users = User.find("all");
  assertEquals(1, users.length);
}

// reload is a find operation
function testReload () {
  var User = new Base('User', 'http://www.thoughtbot.com');
  Base.tree = { parseHTTP : 
    function (url, options, callback) {
      if (url == User._singular_url(1))
        return {'user': ericDetails}
    }
  }
  var eric = User.find(1)
  assertEquals("eric", eric.first_name)
  
  // fake that the user details got updated
  Base.tree = { parseHTTP : 
    function (url, options, callback) {
      if (url == User._singular_url(1))
        return {'user': johnDetails}
    }
  }
  
  eric.reload();
  assertEquals("john", eric.first_name)
}

/********************************************
 ************ ASSOCIATION TESTS *************
 ********************************************/
 
function testRelations () {
  var User = new Base('User');
  Base.tree = { parseHTTP :
    function (url, options, callback) {
      if (url == User._singular_url(1))
        return {'user': ericDetails};
      else if (url == User._singular_url(2))
        return {'user': johnDetails};
    }
  }
  
  var eric = User.find(1);
  assertEquals(2, eric.posts.length);
  
  var john = User.find(2);
  assertEquals(1, john.posts.length);
  
}


/********************************************
 ************ VALIDATION TESTS **************
 ********************************************/

function testValidCheck () {
  var User = new Base('User');
  var user = User.build();
  
  assert(user.valid());
  user.errors[0] = 'error';
  assert(! user.valid());
}

function testInvalidSave () {
  var user = new Base('User');
  user._setProperties({ 'first_name' : '' });
  assert(user.new_record());

  Ajax = { Request : function (url, options) {
	  this.transport = { 
      status : 200,
	    responseText : "<errors><error>First name can't be blank</error></errors>"
	  };
	}}

	assert(! user.save());
	assert(! user.valid());
	assertEquals(1, user.errors.length);
	assertEquals("First name can't be blank", user.errors[0]);

  var user = new Base('User');
	user._setProperties({ 'id' : '1', 'first_name' : '' });
	assert(! user.new_record());

	Ajax = { Request : function (url, options) {
	  this.transport = { 
	    status : 200,
	    responseText : "<errors><error>First name can't be blank</error></errors>"
	  };
  }}

	assert(! user.save());
	assert(! user.valid());
	assertEquals(1, user.errors.length);
	assertEquals("First name can't be blank", user.errors[0]);
}



/********************************************
 ************ CRUD TESTS ********************
 ********************************************/

function testDestroy () {
  var eric = User.build({id: 1})
	Ajax = { Request : function (url, options) { 
	    this.transport = { status : 200 };
	  }
	}
	assertEquals(eric, eric.destroy());
	assertNull(eric.id);

  var eric = User.build({id: 1})
	Ajax = { Request : function (url, options) { 
	    this.transport = { status : 500 };
	  }
	}
	assert(! eric.destroy());
	assertEquals(1, eric.id);
	
	
}

function testSaveNewRecord () {
  var eric = User.build({ 'first_name' : 'eric' });
  assert(eric.new_record());

  Ajax = { Request : function (url, options) {
    this.transport = {
      status : 201,
      getResponseHeader : function (header) {return 'http://www.thoughtbot.com/users/1';}
    };
  }}

	assert(eric.save());
	assertEquals(1, eric.id);
}

function testSaveExistingRecord () {
	var eric = User.build({ 'id' : '1', 'first_name' : 'eric' });
	assert(! eric.new_record());

	Ajax = { Request : function (url, options) {
	  this.transport = { status : 200 };
	}}

	assert(eric.save());
}


/********************************************
 ************ INTERNAL TESTS ****************
 ********************************************/

function testSetProperties () {
  var eric = User.build()
	assertUndefined(eric.first_name);

	eric._setProperties({ 'first_name' : 'eric' });
	assertEquals('eric', eric.first_name);
	assertEquals(1, eric.properties.length);
	assertEquals('first_name', eric.properties[0]);
}

function testSetAssociations () {
  var eric = User.build()
	assertUndefined(eric.posts);
	var posts = [Post.find(1)]

	eric._setAssociations({ 'posts' : posts });
	assertEquals(posts, eric.posts);
	assertEquals(1, eric.associations.length);
	assertEquals('posts', eric.associations[0]);
}

function testNameAccessors () {
  assertEquals('User', User._name);
	assertEquals('user', User._singular);
	assertEquals('users', User._plural);
	assertEquals(default_prefix(), User._prefix);
	assert(User.errors.length == 0);
}
      
function testPrefix () {
  Base.model('User', 'http://www.thoughtbot.com');
  assertEquals('http://www.thoughtbot.com', User._prefix);

  Base.model('User', 'public/forum');
  assertEquals(default_prefix() + '/public/forum', User._prefix);

  Base.model('User', '/public/forum');
  assertEquals(default_prefix() + '/public/forum', User._prefix);
}

function testPluralization () {
  // base case
  Base.model('Person', null);
  assertEquals('person', Person._singular);
  assertEquals('people', Person._plural);
  
  // singular override
  Base.model('Person', null, 'user')
  assertEquals('user', Person._singular);
  assertEquals('users', Person._plural);

  // plural override
  Base.model('Person', null, 'person', 'persons');
  assertEquals('person', Person._singular);
  assertEquals('persons', Person._plural);
}

function testSingularUrl () {
  Base.model('User', 'http://www.thoughtbot.com');
  var eric = User.build({id: 1})
  assertEquals('http://www.thoughtbot.com/users/1.xml', eric._singular_url());
  
  // test version to generate singular urls for any id
  assertEquals('http://www.thoughtbot.com/users/2.xml', eric._singular_url(2));
}

function testPluralUrl () {
  Base.model('User', 'http://www.thoughtbot.com');
  assertEquals('http://www.thoughtbot.com/users.xml', User._plural_url());
}

function testNewRecordCheck () {
  var eric = User.build();
  assert(eric.new_record());
  
  eric.id = 1;
  assert(! eric.new_record());
}

function testErrorsFromTree () {
	var errorTree = { 'error' : ["Name can't be blank", "City can't be blank"] }
	var errors = User._errorsFromTree(errorTree);
	
	assertEquals(2, errors.length);
	assertEquals("Name can't be blank", errors[0]);
	assertEquals("City can't be blank", errors[1]);
}

function testSetErrors () {
  var errors = ["Name can't be blank", "City can't be blank"]
	var eric = new Base('User');
  assert(eric.valid());

	eric._setErrors(errors);
	assert(!eric.valid());
	assertEquals(2, eric.errors.length);
	assertEquals("Name can't be blank", eric.errors[0]);
	assertEquals("City can't be blank", eric.errors[1]);
}

    </script>
  </body>
</html>

